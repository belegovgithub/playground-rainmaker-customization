---
ReportDefinitions:
- reportName: ReceiptRegister
  summary: Receipt Register
  version: 1.0.0
  moduleName: rainmaker-pt
  additionalConfig:
    print:
      pdfPageSize: "A2"
  decryptionPathId: ReceiptRegister
  externalService:
  - entity: $.TenantBoundary[0].boundary
    apiURL: http://egov-location:8080/egov-location/location/v11/boundarys/_search?hierarchyTypeCode=REVENUE&boundaryType=Locality&tenantId=$tenantId
    keyOrder: name,code
    tableName: tbl_boundary
  sourceColumns:
  - name: tenantid
    label: PT_ULB_CITY 
    type: string
    source: pt
    total: false
  - name: propertyid
    label: reports.pt.propertyId 
    type: string
    source: pt
    total: false
  - name: receiptnumber
    label: PT_RECEIPT_RECEIPT_NO 
    type: string
    source: pt
    total: false
  - name: receiptdate
    label: reports.pt.receiptDate
    type: string
    source: pt
    total: false
  - name: paymentmode
    label: PT_RECEIPT_PAYMENT_MODE
    type: string
    source: pt
    total: false
  - name: transactionnumber
    label: PT_RECEIPT_TRANSACTION_ID 
    type: string
    source: pt
    total: false
  - name: interest
    label: reports.pt.interest
    type: string
    source: pt
    total: true
  - name: demandnoticecharge
    label: reports.pt.demandnotice
    type: string
    source: pt
    total: true  
  - name: housetax
    label: reports.pt.housetax
    type: string
    source: pt
    total: true
  - name: watertax
    label: PT_WATER_TAX 
    type: string
    source: pt
    total: true
  - name: conservancytax
    label: PT_CONSERVANCY_TAX
    type: string
    source: pt
    total: true
  - name: lightiningtax
    label: PT_LIGHTINING_TAX
    type: string
    source: pt
    total: true
  - name: educationtax
    label: PT_EDUCATION_TAX
    type: string
    source: pt
    total: true 
  - name: consolidatedpropertytax
    label: PT_CONSOLIDATED_PROPERTY_TAX
    type: string
    source: pt
    total: true 
  - name: sanitarycess
    label: PT_SANITARY_CESS
    type: string
    source: pt
    total: true
  - name: educationcess
    label: PT_EDUCATION_CESS
    type: string
    source: pt
    total: true 
  - name: additionalwatertax
    label: PT_ADDL_WATER_TAX
    type: string
    source: pt
    total: true 
  - name: drainagetax
    label: PT_DRAINAGE_TAX
    type: string
    source: pt
    total: true 
  - name: totalcollection
    label: PT_TOTAL_AMOUNT 
    type: string
    source: pt
    total: true
  - name: collectorname
    label: reports.pt.collectorname
    type: string
    source: pt
    total: false
  - name: mohallaname
    label: PT_PROPERTY_ADDRESS_MOHALLA
    type: string
    source: pt
    total: false
  - name: doorno
    label: PT_COMMON_DOOR_NO_LABEL
    type: string
    source: pt
    total: false
  - name: name
    label: reports.pt.ownername
    type: string
    source: pt
    total: false
  searchParams:
  - name: fromDate
    label: reports.pt.fromDate
    type: epoch
    source: pt
    isMandatory: false
    searchClause: AND pd.receiptdate >= $fromDate
  - name: toDate
    label: reports.pt.toDate
    type: epoch
    source: pt
    isMandatory: false
    searchClause: AND pd.receiptdate <= $toDate
  - name: paymentMode
    label: Payment Mode
    type: singlevaluelist
    pattern: 'list://CARD:CARD,CASH:CASH,CHEQUE:CHEQUE,Online:Online'
    source: pt
    isMandatory: false
    searchClause: AND paymentmode = $paymentMode
  - name: collectorname
    label: Collector Name
    type: singlevaluelist
    pattern: http://egov-hrms:8080/egov-hrms/employees/_search?tenantId=$tenantid&roles=PT_CEMP|$.Employees[*].user.id|$.Employees[*].user.name
    source: pt
    wrapper: true
    isMandatory: false
    searchClause: AND un.id = $collectorname::INTEGER
  query: |
    select initcap(split_part(pay.tenantid, '.', 2)) as tenantid,
    bill.consumercode as propertyid,
    pd.receiptnumber  as receiptnumber,
    To_char(To_timestamp(pd.receiptdate/1000 ), 'DD/MM/YYYY')  AS receiptdate,
    pay.paymentmode as paymentmode,
    pay.transactionnumber as transactionnumber,
    SUM(CASE WHEN taxheadcode LIKE 'PT_TIME_INTEREST%' THEN bad.amount ELSE 0 END) as interest,
    SUM(CASE WHEN taxheadcode LIKE 'PT_DEMANDNOTICE_CHARGE' THEN bad.amount ELSE 0 END) as demandnoticecharge,
    SUM(CASE WHEN taxheadcode LIKE 'PT_HOUSE_TAX' THEN bad.amount ELSE 0 END) as housetax,
    SUM(CASE WHEN taxheadcode LIKE 'PT_WATER_TAX'  THEN bad.amount ELSE 0 END) as watertax ,
    SUM(CASE WHEN taxheadcode LIKE 'PT_CONSERVANCY_TAX' THEN bad.amount ELSE 0 END) as conservancytax ,
    SUM(CASE WHEN taxheadcode LIKE 'PT_LIGHTINING_TAX' THEN bad.amount ELSE 0 END) as lightiningtax ,
    SUM(CASE WHEN taxheadcode LIKE 'PT_EDUCATION_TAX' THEN bad.amount ELSE 0 END) as educationtax ,
    SUM(CASE WHEN taxheadcode LIKE 'PT_CONSOLIDATED_PROPERTY_TAX' THEN bad.amount ELSE 0 END) as consolidatedpropertytax,
    SUM(CASE WHEN taxheadcode LIKE 'PT_SANITARY_CESS' THEN bad.amount ELSE 0 END) as sanitarycess,
    SUM(CASE WHEN taxheadcode LIKE 'PT_EDUCATION_CESS' THEN bad.amount ELSE 0 END) as educationcess,
    SUM(CASE WHEN taxheadcode LIKE 'PT_ADDL_WATER_TAX' THEN bad.amount ELSE 0 END) as additionalwatertax,
    SUM(CASE WHEN taxheadcode LIKE 'PT_DRAINAGE_TAX' THEN bad.amount ELSE 0 END) as drainagetax,
    pd.amountpaid as totalcollection,
    un.name as collectorname,
    addr.doorno as doorno,
    (SELECT boundary_def.name FROM (VALUES tbl_boundary) AS boundary_def(name,code) where code=addr.locality) as mohallaname,
    poo.name as name
    from eg_pt_property pt
    Join eg_pt_address as addr on addr.propertyid=pt.id
    INNER JOIN egcl_bill as bill ON bill.consumercode = pt.propertyid  and bill.status != 'Cancelled'
    JOIN egcl_billdetial as bd ON bd.billid = bill.id
    INNER JOIN egcl_billaccountdetail as bad ON bd.id = bad .billdetailid
    LEFT OUTER JOIN egcl_paymentdetail as pd ON pd.billid = bill.id
    LEFT OUTER JOIN egcl_payment as pay ON pay.id = pd.paymentid and pay.paymentstatus != 'CANCELLED'
    LEFT OUTER Join eg_pg_transactions as pgtxn ON pay.transactionnumber = pgtxn.txn_id
    LEFT JOIN (
      SELECT propertyid, array_to_string(array_agg(name),', ') as name, array_to_string(array_agg(mobilenumber),', ') as mobilenumber
      FROM eg_pt_owner poo
      INNER JOIN eg_user ptuser ON ptuser.uuid = poo.userid group by propertyid) 
      poo ON poo.propertyid = pt.id
      JOIN eg_user as un ON pay.createdby::INTEGER=un.id
      where pay.tenantid LIKE $tenantid  and pd.businessservice='PT'and pay.paymentstatus != 'CANCELLED'
  groupby: GROUP BY pay.tenantid,pd.receiptnumber,bill.consumercode,pd.receiptdate,pay.transactionnumber,pay.paymentmode,addr.doorno,poo.name,pd.amountpaid,un.name,addr.locality

- reportName: CancelledReceiptRegister
  summary: Receipt Register for cancelled Receipts
  version: 1.0.0
  moduleName: rainmaker-pt
  externalService:
  - entity: $.TenantBoundary[0].boundary
    apiURL: http://egov-location:8080/egov-location/location/v11/boundarys/_search?hierarchyTypeCode=REVENUE&boundaryType=Locality&tenantId=$tenantId
    keyOrder: name,code
    tableName: tbl_boundary
  sourceColumns:
  - name: tenantid
    label: PT_ULB_CITY 
    type: string
    source: pt
    total: false
  - name: propertyid
    label: reports.pt.propertyId 
    type: string
    source: pt
    total: false
  - name: receiptnumber
    label: PT_RECEIPT_RECEIPT_NO 
    type: string
    source: pt
    total: false
  - name: receiptdate
    label: reports.pt.receiptDate
    type: string
    source: pt
    total: false
  - name: paymentmode
    label: PT_RECEIPT_PAYMENT_MODE
    type: string
    source: pt
    total: false
  - name: transactionnumber
    label: PT_RECEIPT_TRANSACTION_ID 
    type: string
    source: pt
    total: false
  - name: interest
    label: reports.pt.interest
    type: string
    source: pt
    total: false
  - name: demandnoticecharge
    label: reports.pt.demandnotice
    type: string
    source: pt
    total: true   
  - name: housetax
    label: reports.pt.housetax
    type: string
    source: pt
    total: true
  - name: watertax
    label: PT_WATER_TAX 
    type: string
    source: pt
    total: true
  - name: conservancytax
    label: PT_CONSERVANCY_TAX
    type: string
    source: pt
    total: true
  - name: lightiningtax
    label: PT_LIGHTINING_TAX
    type: string
    source: pt
    total: true
  - name: educationtax
    label: PT_EDUCATION_TAX
    type: string
    source: pt
    total: true  
  - name: consolidatedpropertytax
    label: PT_CONSOLIDATED_PROPERTY_TAX
    type: string
    source: pt
    total: true 
  - name: sanitarycess
    label: PT_SANITARY_CESS
    type: string
    source: pt
    total: true
  - name: educationcess
    label: PT_EDUCATION_CESS
    type: string
    source: pt
    total: true 
  - name: additionalwatertax
    label: PT_ADDL_WATER_TAX
    type: string
    source: pt
    total: true 
  - name: drainagetax
    label: PT_DRAINAGE_TAX
    type: string
    source: pt
    total: true  
  - name: totalcollection
    label: PT_TOTAL_AMOUNT 
    type: string
    source: pt
    total: false
  searchParams:
  - name: fromDate
    label: reports.pt.fromDate
    type: epoch
    source: pt
    isMandatory: false
    searchClause: AND pd.receiptdate >= $fromDate
  - name: toDate
    label: reports.pt.toDate
    type: epoch
    source: pt
    isMandatory: false
    searchClause: AND pd.receiptdate <= $toDate
  - name: paymentMode
    label: Payment Mode
    type: singlevaluelist
    pattern: 'list://CARD:CARD,CASH:CASH,CHEQUE:CHEQUE,Online:Online'
    source: pt
    isMandatory: false
    searchClause: AND paymentmode = $paymentMode
  query: |
    select initcap(split_part(pay.tenantid, '.', 2)) as tenantid,
    bill.consumercode as propertyid,
    pd.receiptnumber  as receiptnumber,
    To_char(To_timestamp(pd.receiptdate/1000 ), 'DD/MM/YYYY')  AS receiptdate,
    pay.paymentmode as paymentmode,
    pay.transactionnumber as transactionnumber,
    SUM(CASE WHEN taxheadcode LIKE 'PT_TIME_INTEREST%' THEN bad.amount ELSE 0 END) as interest,
    SUM(CASE WHEN taxheadcode LIKE 'PT_DEMANDNOTICE_CHARGE' THEN bad.amount ELSE 0 END) as demandnoticecharge,
    SUM(CASE WHEN taxheadcode LIKE 'PT_HOUSE_TAX' THEN bad.amount ELSE 0 END) as housetax,
    SUM(CASE WHEN taxheadcode LIKE 'PT_WATER_TAX'  THEN bad.amount ELSE 0 END) as watertax ,
    SUM(CASE WHEN taxheadcode LIKE 'PT_CONSERVANCY_TAX' THEN bad.amount ELSE 0 END) as conservancytax ,
    SUM(CASE WHEN taxheadcode LIKE 'PT_LIGHTINING_TAX' THEN bad.amount ELSE 0 END) as lightiningtax ,
    SUM(CASE WHEN taxheadcode LIKE 'PT_EDUCATION_TAX' THEN bad.amount ELSE 0 END) as educationtax ,
    SUM(CASE WHEN taxheadcode LIKE 'PT_CONSOLIDATED_PROPERTY_TAX' THEN bad.amount ELSE 0 END) as consolidatedpropertytax,
    SUM(CASE WHEN taxheadcode LIKE 'PT_SANITARY_CESS' THEN bad.amount ELSE 0 END) as sanitarycess,
    SUM(CASE WHEN taxheadcode LIKE 'PT_EDUCATION_CESS' THEN bad.amount ELSE 0 END) as educationcess,
    SUM(CASE WHEN taxheadcode LIKE 'PT_ADDL_WATER_TAX' THEN bad.amount ELSE 0 END) as additionalwatertax,
    SUM(CASE WHEN taxheadcode LIKE 'PT_DRAINAGE_TAX' THEN bad.amount ELSE 0 END) as drainagetax,
    pd.amountpaid as totalcollection,
    un.name as collectorname,
    addr.doorno as doorno,
    (SELECT boundary_def.name FROM (VALUES tbl_boundary) AS boundary_def(name,code) where code=addr.locality) as mohallaname,
    poo.name
    from eg_pt_property pt
    Join eg_pt_address as addr on addr.propertyid=pt.id
    INNER JOIN egcl_bill as bill ON bill.consumercode = pt.propertyid  and bill.status = 'Cancelled'
    JOIN egcl_billdetial as bd ON bd.billid = bill.id
    INNER JOIN egcl_billaccountdetail as bad ON bd.id = bad .billdetailid
    LEFT OUTER JOIN egcl_paymentdetail as pd ON pd.billid = bill.id
    LEFT OUTER JOIN egcl_payment as pay ON pay.id = pd.paymentid and pay.paymentstatus != 'CANCELLED'
    LEFT OUTER Join eg_pg_transactions as pgtxn ON pay.transactionnumber = pgtxn.txn_id
    LEFT JOIN (
      SELECT propertyid, array_to_string(array_agg(name),', ') as name, array_to_string(array_agg(mobilenumber),', ') as mobilenumber
      FROM eg_pt_owner poo
      INNER JOIN eg_user ptuser ON ptuser.uuid = poo.userid group by propertyid) 
      poo ON poo.propertyid = pt.id
      JOIN eg_user as un ON pay.createdby::INTEGER=un.id
      where pay.tenantid LIKE $tenantid  and pd.businessservice='PT'and pay.paymentstatus = 'CANCELLED'
  groupby: GROUP BY pay.tenantid,pd.receiptnumber,bill.consumercode,pd.receiptdate,pay.transactionnumber,pay.paymentmode,addr.doorno,poo.name,pd.amountpaid,un.name,addr.locality

- reportName: CBPTCollection
  summary: CB wise PT Collection
  version: 1.0.0
  moduleName: rainmaker-pt
  sourceColumns:
  - name: totalassessments
    label: reports.pt.totalassessments
    type: string
    source: pt
    total: true
  - name: totalamount
    label: PT_TOTAL_AMOUNT
    type: string
    source: pt
    total: true
  - name: totalamountpaid
    label: PT_AMOUNT_PAID
    type: string
    source: pt
    total: true
  - name: offline
    label: reports.pt.totaloffline
    type: string
    source: pt
    total: true
  - name: online
    label: reports.pt.totalonline
    type: string
    source: pt
    total: true
  - name: totalamountdue
    label: PT_TOTAL_DUES
    type: string
    source: pt
    total: true
  searchParams:
  - name: financialyear
    label: Financial Year
    type: singlevaluelist
    pattern: http://egov-mdms-service:8080/egov-mdms-service/v1/_get?tenantId=$tenantid&moduleName=egf-master&masterName=FinancialYear|$.MdmsRes.egf-master.FinancialYear.[?(@.module=='PT')].code|$.MdmsRes.egf-master.FinancialYear.[?(@.module=='PT')].name
    source: pt
    wrapper: true
    isMandatory: false
    searchClause: AND financialyear = $financialyear
  query: |
    SELECT 
      bill.tenantid, 
      COUNT(*) AS totalassessments,
      SUM(bill.totalamount) AS totalamount, 
      SUM(pd.amountpaid) AS totalamountpaid,
      SUM(onl.totalamountpaid) as online,
      SUM(offl.totalamountpaid) as offline, 
      (SUM(bill.totalamount) - SUM(pd.amountpaid)) AS totalamountdue
    FROM eg_pt_asmt_assessment AS asmt
    LEFT OUTER JOIN (Select DISTINCT on (consumercode) bill.id,tenantid,consumercode,status,totalamount from egcl_bill bill ) as bill ON bill.consumercode = asmt.propertyid  and bill.status != 'Cancelled'
    LEFT OUTER JOIN (SELECT billid,amountpaid,paymentid from egcl_paymentdetail pd ) as pd ON pd.billid = bill.id
    LEFT OUTER JOIN (SELECT id,paymentmode,totalamountpaid FROM egcl_payment WHERE paymentmode = 'ONLINE') AS onl ON onl.id = pd.paymentid 
    LEFT OUTER JOIN (SELECT id,paymentmode,totalamountpaid FROM egcl_payment WHERE paymentmode != 'ONLINE' ) AS offl ON offl.id = pd.paymentid   
    WHERE bill.tenantid = $tenantid
  groupby: GROUP BY bill.tenantid
  orderby: ORDER BY bill.tenantid

- reportName: StateCancelledReceiptRegister
  summary: Receipt Register for cancelled Receipts State
  version: 1.0.0
  moduleName: rainmaker-pt
  externalService:
  - entity: $.TenantBoundary[0].boundary
    apiURL: http://egov-location:8080/egov-location/location/v11/boundarys/_search?hierarchyTypeCode=REVENUE&boundaryType=Locality&tenantId=$tenantId
    keyOrder: name,code
    tableName: tbl_boundary
  sourceColumns:
  - name: tenantid
    label: PT_ULB_CITY 
    type: string
    source: pt
    total: false
  - name: propertyid
    label: reports.pt.propertyId 
    type: string
    source: pt
    total: false
  - name: receiptnumber
    label: PT_RECEIPT_RECEIPT_NO 
    type: string
    source: pt
    total: false
  - name: receiptdate
    label: reports.pt.receiptDate
    type: string
    source: pt
    total: false
  - name: paymentmode
    label: PT_RECEIPT_PAYMENT_MODE
    type: string
    source: pt
    total: false
  - name: transactionnumber
    label: PT_RECEIPT_TRANSACTION_ID 
    type: string
    source: pt
    total: false
  - name: interest
    label: reports.pt.interest
    type: string
    source: pt
    total: false
  - name: demandnoticecharge
    label: reports.pt.demandnotice
    type: string
    source: pt
    total: true  
  - name: housetax
    label: reports.pt.housetax
    type: string
    source: pt
    total: true
  - name: watertax
    label: PT_WATER_TAX 
    type: string
    source: pt
    total: true
  - name: conservancytax
    label: PT_CONSERVANCY_TAX
    type: string
    source: pt
    total: true
  - name: lightiningtax
    label: PT_LIGHTINING_TAX
    type: string
    source: pt
    total: true
  - name: educationtax
    label: PT_EDUCATION_TAX
    type: string
    source: pt 
    total: true  
  - name: consolidatedpropertytax
    label: PT_CONSOLIDATED_PROPERTY_TAX
    type: string
    source: pt
    total: true 
  - name: sanitarycess
    label: PT_SANITARY_CESS
    type: string
    source: pt
    total: true
  - name: educationcess
    label: PT_EDUCATION_CESS
    type: string
    source: pt
    total: true 
  - name: additionalwatertax
    label: PT_ADDL_WATER_TAX
    type: string
    source: pt
    total: true 
  - name: drainagetax
    label: PT_DRAINAGE_TAX
    type: string
    source: pt
    total: true 
  - name: totalcollection
    label: PT_TOTAL_AMOUNT 
    type: string
    source: pt
    total: false
  searchParams:
  - name: fromDate
    label: reports.pt.fromDate
    type: epoch
    source: pt
    isMandatory: false
    searchClause: AND pd.receiptdate >= $fromDate
  - name: toDate
    label: reports.pt.toDate
    type: epoch
    source: pt
    isMandatory: false
    searchClause: AND pd.receiptdate <= $toDate
  - name: ulb
    label: PT_ULB_CITY
    type: singlevaluelist
    pattern: http://egov-mdms-service:8080/egov-mdms-service/v1/_get?tenantId=$tenantid&moduleName=tenant&masterName=tenants|$.MdmsRes.tenant.tenants.*.code|$.MdmsRes.tenant.tenants.*.name
    source: pt
    wrapper: true
    isMandatory: false
    searchClause: AND pay.tenantid = $ulb
  - name: paymentMode
    label: Payment Mode
    type: singlevaluelist
    pattern: 'list://CASH:CASH,Online:Online,CARD:CARD,DD:DD,CHEQUE:CHEQUE'
    source: pt
    isMandatory: false
    searchClause: AND paymentmode = $paymentMode
  query: |
    select initcap(split_part(pay.tenantid, '.', 2)) as tenantid,
    bill.consumercode as propertyid,
    pd.receiptnumber  as receiptnumber,
    To_char(To_timestamp(pd.receiptdate/1000 ), 'DD/MM/YYYY')  AS receiptdate,
    pay.paymentmode as paymentmode,
    pay.transactionnumber as transactionnumber,
    SUM(CASE WHEN taxheadcode LIKE 'PT_TIME_INTEREST%' THEN bad.amount ELSE 0 END) as interest,
    SUM(CASE WHEN taxheadcode LIKE 'PT_DEMANDNOTICE_CHARGE' THEN bad.amount ELSE 0 END) as demandnoticecharge,
    SUM(CASE WHEN taxheadcode LIKE 'PT_HOUSE_TAX' THEN bad.amount ELSE 0 END) as housetax,
    SUM(CASE WHEN taxheadcode LIKE 'PT_WATER_TAX'  THEN bad.amount ELSE 0 END) as watertax ,
    SUM(CASE WHEN taxheadcode LIKE 'PT_CONSERVANCY_TAX' THEN bad.amount ELSE 0 END) as conservancytax ,
    SUM(CASE WHEN taxheadcode LIKE 'PT_LIGHTINING_TAX' THEN bad.amount ELSE 0 END) as lightiningtax ,
    SUM(CASE WHEN taxheadcode LIKE 'PT_EDUCATION_TAX' THEN bad.amount ELSE 0 END) as educationtax ,
    SUM(CASE WHEN taxheadcode LIKE 'PT_CONSOLIDATED_PROPERTY_TAX' THEN bad.amount ELSE 0 END) as consolidatedpropertytax,
    SUM(CASE WHEN taxheadcode LIKE 'PT_SANITARY_CESS' THEN bad.amount ELSE 0 END) as sanitarycess,
    SUM(CASE WHEN taxheadcode LIKE 'PT_EDUCATION_CESS' THEN bad.amount ELSE 0 END) as educationcess,
    SUM(CASE WHEN taxheadcode LIKE 'PT_ADDL_WATER_TAX' THEN bad.amount ELSE 0 END) as additionalwatertax,
    SUM(CASE WHEN taxheadcode LIKE 'PT_DRAINAGE_TAX' THEN bad.amount ELSE 0 END) as drainagetax,
    pd.amountpaid as totalcollection,
    un.name as collectorname,
    addr.doorno as doorno,
    (SELECT boundary_def.name FROM (VALUES tbl_boundary) AS boundary_def(name,code) where code=addr.locality) as mohallaname,
    poo.name as name
    from eg_pt_property pt
    Join eg_pt_address as addr on addr.propertyid=pt.id
    INNER JOIN egcl_bill as bill ON bill.consumercode = pt.propertyid  and bill.status = 'Cancelled'
    JOIN egcl_billdetial as bd ON bd.billid = bill.id
    INNER JOIN egcl_billaccountdetail as bad ON bd.id = bad .billdetailid
    LEFT OUTER JOIN egcl_paymentdetail as pd ON pd.billid = bill.id
    LEFT OUTER JOIN egcl_payment as pay ON pay.id = pd.paymentid and pay.paymentstatus != 'CANCELLED'
    LEFT OUTER Join eg_pg_transactions as pgtxn ON pay.transactionnumber = pgtxn.txn_id
    LEFT JOIN (
      SELECT propertyid, array_to_string(array_agg(name),', ') as name, array_to_string(array_agg(mobilenumber),', ') as mobilenumber
      FROM eg_pt_owner poo
      INNER JOIN eg_user ptuser ON ptuser.uuid = poo.userid group by propertyid) 
      poo ON poo.propertyid = pt.id
      JOIN eg_user as un ON pay.createdby::INTEGER=un.id
      where pay.tenantid  != 'pb.testing' pd.businessservice='PT'and pay.paymentstatus = 'CANCELLED'
  groupby: GROUP BY pay.tenantid,pd.receiptnumber,bill.consumercode,pd.receiptdate,pay.transactionnumber,pay.paymentmode,addr.doorno,poo.name,pd.amountpaid,un.name,addr.locality

- reportName: CBWidePtCollection
  summary: CB Wide PT Collection
  version: 1.0.0
  moduleName: rainmaker-pt
  sourceColumns:
  - name: tenantid
    label: reports.pt.ulbName
    type: string
    source: pt
    total: false
  - name: totalassessments
    label: reports.pt.totalassessments
    type: string
    source: pt
    total: true
  - name: totalamount
    label: PT_TOTAL_AMOUNT
    type: string
    source: pt
    total: true  
  - name: totalamountpaid
    label: PT_AMOUNT_PAID
    type: string
    source: pt
    total: true
  - name: offline
    label: reports.pt.totaloffline
    type: string
    source: pt
    total: true
  - name: online
    label: reports.pt.totalonline
    type: string
    source: pt
    total: true
  - name: totalamountdue
    label: PT_TOTAL_DUES
    type: string
    source: pt
    total: true
  searchParams:
  - name: fromDate
    label: reports.pt.fromDate
    type: epoch
    source: pt
    isMandatory: false
    searchClause: AND receiptdate >= $fromDate
  - name: toDate
    label: reports.pt.toDate
    type: epoch
    source: pt
    isMandatory: false
    searchClause: AND receiptdate <= $toDate
  - name: ulb
    label: PT_ULB_CITY
    type: singlevaluelist
    pattern: http://egov-mdms-service:8080/egov-mdms-service/v1/_get?tenantId=$tenantid&moduleName=tenant&masterName=tenants|$.MdmsRes.tenant.tenants.*.code|$.MdmsRes.tenant.tenants.*.name
    source: pt
    wrapper: true
    isMandatory: false
    searchClause: AND bill.tenantid = $ulb
  - name: financialyear
    label: Financial Year
    type: singlevaluelist
    pattern: http://egov-mdms-service:8080/egov-mdms-service/v1/_get?tenantId=$tenantid&moduleName=egf-master&masterName=FinancialYear|$.MdmsRes.egf-master.FinancialYear.[?(@.module=='PT')].code|$.MdmsRes.egf-master.FinancialYear.[?(@.module=='PT')].name
    source: pt
    wrapper: true
    isMandatory: false
    searchClause: AND financialyear = $financialyear
  query: |
    SELECT 
      initcap(split_part(bill.tenantid, '.', 2)) as tenantid, 
      COUNT(*) AS totalassessments,
      SUM(bill.totalamount) AS totalamount, 
      SUM(pd.amountpaid) AS totalamountpaid,
      SUM(onl.totalamountpaid) as online,
      SUM(offl.totalamountpaid) as offline, 
      (SUM(bill.totalamount) - SUM(pd.amountpaid)) AS totalamountdue
    FROM eg_pt_asmt_assessment AS asmt
    LEFT OUTER JOIN (Select DISTINCT on (consumercode) bill.id,tenantid,consumercode,status,totalamount from egcl_bill bill ) as bill ON bill.consumercode = asmt.propertyid  and bill.status != 'Cancelled'
    LEFT OUTER JOIN (SELECT billid,amountpaid,paymentid from egcl_paymentdetail pd ) as pd ON pd.billid = bill.id
    LEFT OUTER JOIN (SELECT id,paymentmode,totalamountpaid FROM egcl_payment WHERE paymentmode = 'ONLINE') AS onl ON onl.id = pd.paymentid 
    LEFT OUTER JOIN (SELECT id,paymentmode,totalamountpaid FROM egcl_payment WHERE paymentmode != 'ONLINE' ) AS offl ON offl.id = pd.paymentid   
    WHERE bill.tenantid != 'pb.testing'
  groupby: GROUP BY bill.tenantid
  orderby: ORDER BY bill.tenantid, totalamountpaid DESC NULLS LAST

- reportName: UlbWisePtCollection
  summary: State Wide PT Collection
  version: 1.0.0
  moduleName: rainmaker-pt
  sourceColumns:
  - name: totalassessments
    label: reports.pt.totalassessments
    type: string
    source: pt
    total: true
  - name: totalamountpaid
    label: PT_AMOUNT_PAID
    type: string
    source: pt
    total: true
  - name: totaloffline
    label: reports.pt.totaloffline
    type: string
    source: pt
    total: true
  - name: totalonline
    label: reports.pt.totalonline
    type: string
    source: pt
    total: true
  - name: totalamountdue
    label: PT_TOTAL_DUES
    type: string
    source: pt
    total: true
  searchParams:
  - name: fromDate
    label: reports.pt.fromDate
    type: epoch
    source: pt
    isMandatory: false
    searchClause: AND receiptdate >= $fromDate
  - name: toDate
    label: reports.pt.toDate
    type: epoch
    source: pt
    isMandatory: false
    searchClause: AND receiptdate <= $toDate
  - name: financialyear
    label: Financial Year
    type: singlevaluelist
    pattern: http://egov-mdms-service:8080/egov-mdms-service/v1/_get?tenantId=$tenantid&moduleName=egf-master&masterName=FinancialYear|$.MdmsRes.egf-master.FinancialYear.[?(@.module=='PT')].code|$.MdmsRes.egf-master.FinancialYear.[?(@.module=='PT')].name
    source: pt
    wrapper: true
    isMandatory: false
    searchClause: AND financialyear = $financialyear
  - name: usage
    label: Usage
    type: singlevaluelist
    pattern: http://egov-mdms-service:8080/egov-mdms-service/v1/_get?tenantId=$tenantid&moduleName=PropertyTax&masterName=UsageCategoryMajor|$..code|$..name
    source: pt
    wrapper: true
    isMandatory: false
    searchClause: AND usagecategorymajor = $usage
  query: |
      SELECT 
      initcap(split_part(tenantid, '.', 2)) as tenantid, 
      COUNT(*) AS totalassessments, 
      SUM(totalamount) AS totalamount, 
      SUM(amount) AS totalamountpaid, 
      SUM(CASE WHEN collectiontype LIKE 'ONLINE' THEN amount ELSE 0 END) AS totalonline, 
      SUM(CASE WHEN collectiontype LIKE 'COUNTER' THEN amount ELSE 0 END) AS totaloffline, 
      (SUM(totalamount) - SUM(amount)) AS totalamountdue 
      FROM eg_pt_propertydetail_v2 AS pd 
      LEFT OUTER JOIN (SELECT consumercode, totalamount, amount, collectiontype, receiptdate FROM egcl_receiptheader AS rh 
      LEFT OUTER JOIN egcl_receiptinstrument AS ri ON rh.id = ri.receiptheader 
      LEFT OUTER JOIN egcl_instrumentheader AS ih ON ri.instrumentheader = ih.id and ih.instrumentstatus	 != 'CANCELLED' 
      where rh.status != 'Cancelled'
      ) AS tbl_amounts ON CONCAT(pd.property, ':', pd.assessmentnumber) = tbl_amounts.consumercode 
      WHERE tenantid LIKE CONCAT(SPLIT_PART($tenantid, '.', 1), '%') and tenantid = $tenantid
  groupby: GROUP BY tenantid
  orderby: ORDER BY tenantid, totalamountpaid DESC NULLS LAST

- reportName: DGDEReceiptRegister
  summary: Receipt Register
  version: 1.0.0
  moduleName: rainmaker-pt
  decryptionPathId: DGDEReceiptRegister
  externalService:
  - entity: $.TenantBoundary[0].boundary
    apiURL: http://egov-location:8080/egov-location/location/v11/boundarys/_search?hierarchyTypeCode=REVENUE&boundaryType=Locality&tenantId=$tenantId
    keyOrder: name,code
    tableName: tbl_boundary
  sourceColumns:
  - name: tenantid
    label: PT_ULB_CITY 
    type: string
    source: pt
    total: false
  - name: propertyid
    label: reports.pt.propertyId 
    type: string
    source: pt
    total: false
  - name: receiptnumber
    label: PT_RECEIPT_RECEIPT_NO 
    type: string
    source: pt
    total: false
  - name: receiptdate
    label: reports.pt.receiptDate
    type: string
    source: pt
    total: false
  - name: paymentmode
    label: PT_RECEIPT_PAYMENT_MODE
    type: string
    source: pt
    total: false
  - name: transactionnumber
    label: PT_RECEIPT_TRANSACTION_ID 
    type: string
    source: pt
    total: false
  - name: interest
    label: reports.pt.interest
    type: string
    source: pt
    total: true
  - name: demandnoticecharge
    label: reports.pt.demandnotice
    type: string
    source: pt
    total: true   
  - name: housetax
    label: reports.pt.housetax
    type: string
    source: pt
    total: true
  - name: watertax
    label: PT_WATER_TAX 
    type: string
    source: pt
    total: true
  - name: conservancytax
    label: PT_CONSERVANCY_TAX
    type: string
    source: pt
    total: true
  - name: lightiningtax
    label: PT_LIGHTINING_TAX
    type: string
    source: pt
    total: true
  - name: educationtax
    label: PT_EDUCATION_TAX
    type: string
    source: pt
    total: true 
  - name: consolidatedpropertytax
    label: PT_CONSOLIDATED_PROPERTY_TAX
    type: string
    source: pt
    total: true 
  - name: sanitarycess
    label: PT_SANITARY_CESS
    type: string
    source: pt
    total: true
  - name: educationcess
    label: PT_EDUCATION_CESS
    type: string
    source: pt
    total: true 
  - name: additionalwatertax
    label: PT_ADDL_WATER_TAX
    type: string
    source: pt
    total: true 
  - name: drainagetax
    label: PT_DRAINAGE_TAX
    type: string
    source: pt
    total: true 
  - name: totalcollection
    label: PT_TOTAL_AMOUNT 
    type: string
    source: pt
    total: true
  - name: collectorname
    label: reports.pt.collectorname
    type: string
    source: pt
    total: false
  - name: mohallaname
    label: PT_PROPERTY_ADDRESS_MOHALLA
    type: string
    source: pt
    total: false
  - name: doorno
    label: PT_COMMON_DOOR_NO_LABEL
    type: string
    source: pt
    total: false
  - name: ownername
    label: reports.pt.ownername
    type: string
    source: pt
    total: false
  searchParams:
  - name: fromDate
    label: reports.pt.fromDate
    type: epoch
    source: pt
    isMandatory: false
    searchClause: AND pd.receiptdate >= $fromDate
  - name: toDate
    label: reports.pt.toDate
    type: epoch
    source: pt
    isMandatory: false
    searchClause: AND pd.receiptdate <= $toDate
  - name: ulb
    label: PT_ULB_CITY
    type: singlevaluelist
    pattern: http://egov-mdms-service:8080/egov-mdms-service/v1/_get?tenantId=$tenantid&moduleName=tenant&masterName=tenants|$.MdmsRes.tenant.tenants.*.code|$.MdmsRes.tenant.tenants.*.name
    source: pt
    wrapper: true
    isMandatory: false
    searchClause: AND pay.tenantid = $ulb
  - name: paymentMode
    label: Payment Mode
    type: singlevaluelist
    pattern: 'list://CASH:CASH,Online:Online,CARD:CARD,DD:DD,CHEQUE:CHEQUE'
    source: pt
    isMandatory: false
    searchClause: AND paymentmode = $paymentMode
  - name: collectorname
    label: Collector Name
    type: singlevaluelist
    pattern: http://egov-hrms:8080/egov-hrms/employees/_search?tenantId=$tenantid&roles=PTCEMP|$.Employees[*].user.id|$.Employees[*].user.name
    source: pt
    wrapper: true
    isMandatory: false
    searchClause: AND un.id = $collectorname::INTEGER
  query: |
    select initcap(split_part(pay.tenantid, '.', 2)) as tenantid,
    bill.consumercode as propertyid,
    pd.receiptnumber  as receiptnumber,
    To_char(To_timestamp(pd.receiptdate/1000 ), 'DD/MM/YYYY')  AS receiptdate,
    pay.paymentmode as paymentmode,
    pay.transactionnumber as transactionnumber,
    SUM(CASE WHEN taxheadcode LIKE 'PT_TIME_INTEREST%' THEN bad.amount ELSE 0 END) as interest,
    SUM(CASE WHEN taxheadcode LIKE 'PT_DEMANDNOTICE_CHARGE' THEN bad.amount ELSE 0 END) as demandnoticecharge,
    SUM(CASE WHEN taxheadcode LIKE 'PT_HOUSE_TAX' THEN bad.amount ELSE 0 END) as housetax,
    SUM(CASE WHEN taxheadcode LIKE 'PT_WATER_TAX'  THEN bad.amount ELSE 0 END) as watertax ,
    SUM(CASE WHEN taxheadcode LIKE 'PT_CONSERVANCY_TAX' THEN bad.amount ELSE 0 END) as conservancytax ,
    SUM(CASE WHEN taxheadcode LIKE 'PT_LIGHTINING_TAX' THEN bad.amount ELSE 0 END) as lightiningtax ,
    SUM(CASE WHEN taxheadcode LIKE 'PT_EDUCATION_TAX' THEN bad.amount ELSE 0 END) as educationtax ,
    SUM(CASE WHEN taxheadcode LIKE 'PT_CONSOLIDATED_PROPERTY_TAX' THEN bad.amount ELSE 0 END) as consolidatedpropertytax,
    SUM(CASE WHEN taxheadcode LIKE 'PT_SANITARY_CESS' THEN bad.amount ELSE 0 END) as sanitarycess,
    SUM(CASE WHEN taxheadcode LIKE 'PT_EDUCATION_CESS' THEN bad.amount ELSE 0 END) as educationcess,
    SUM(CASE WHEN taxheadcode LIKE 'PT_ADDL_WATER_TAX' THEN bad.amount ELSE 0 END) as additionalwatertax,
    SUM(CASE WHEN taxheadcode LIKE 'PT_DRAINAGE_TAX' THEN bad.amount ELSE 0 END) as drainagetax,
    pd.amountpaid as totalcollection,
    un.name as collectorname,
    addr.doorno as doorno,
    (SELECT boundary_def.name FROM (VALUES tbl_boundary) AS boundary_def(name,code) where code=addr.locality) as mohallaname,
    poo.name as name
    from eg_pt_property pt
    Join eg_pt_address as addr on addr.propertyid=pt.id
    INNER JOIN egcl_bill as bill ON bill.consumercode = pt.propertyid  and bill.status != 'Cancelled'
    JOIN egcl_billdetial as bd ON bd.billid = bill.id
    INNER JOIN egcl_billaccountdetail as bad ON bd.id = bad .billdetailid
    LEFT OUTER JOIN egcl_paymentdetail as pd ON pd.billid = bill.id
    LEFT OUTER JOIN egcl_payment as pay ON pay.id = pd.paymentid and pay.paymentstatus != 'CANCELLED'
    LEFT OUTER Join eg_pg_transactions as pgtxn ON pay.transactionnumber = pgtxn.txn_id
    LEFT JOIN (
      SELECT propertyid, array_to_string(array_agg(name),', ') as name, array_to_string(array_agg(mobilenumber),', ') as mobilenumber
      FROM eg_pt_owner poo
      INNER JOIN eg_user ptuser ON ptuser.uuid = poo.userid group by propertyid) 
      poo ON poo.propertyid = pt.id
      JOIN eg_user as un ON pay.createdby::INTEGER=un.id
      where pay.tenantid != 'pb.testing' pd.businessservice='PT'and pay.paymentstatus != 'CANCELLED'
  groupby: GROUP BY pay.tenantid,pd.receiptnumber,bill.consumercode,pd.receiptdate,pay.transactionnumber,pay.paymentmode,addr.doorno,poo.name,pd.amountpaid,un.name,addr.locality

- reportName: DemandRegisterReport
  summary: Reports for Reconcillation of data in PT
  version: 1.0.0
  moduleName: rainmaker-pt
  decryptionPathId: DemandRegisterReport
  additionalConfig:
    print:
      pdfPageSize: "A2"
  externalService:
  - entity: $.TenantBoundary[0].boundary
    apiURL: http://egov-location:8080/egov-location/location/v11/boundarys/_search?hierarchyTypeCode=REVENUE&boundaryType=Locality&tenantId=$tenantId
    keyOrder: name,code
    tableName: tbl_boundary
  sourceColumns:
  - name: propertyid
    label: reports.pt.propertyId
    type: string
    source: pt
    total: false
  - name: oldcode
    label: PT_EXISTING_PROPERTY_ID
    type: string
    source: pt
    total: false
  - name: name
    label: PT_OWNER_NAME
    type: string
    total: false
    source: pt
  - name: mobilenumber
    label: PT_COMMON_APPLICANT_MOBILE_NO_LABEL
    type: string
    total: false
    source: pt    
  - name: addr
    label: reports.pt.address
    type: string
    source: pt
    total: false
  - name: usagetype
    label: PT_COMMON_USAGE_TYPE
    type: string
    source: pt
    total: false
  - name: subusagetype
    label: PT_COMMON_SUB_USAGE_TYPE
    type: string
    source: pt
    total: false
  - name: arv
    label: PT_ASSESMENT_INFO_AREA_RENT
    type: string
    source: pt
    total: true   
  - name: Demand
    label: reports.pt.demand
    type: string
    source: pt
    total: true
  - name: totalcollected
    label: PT_COLLECTED
    type: string
    source: pt
    total: true
  - name: excessadjustment
    label: PT_EXCESSADJUSTMENT
    type: string
    source: pt
    total: true
  - name: billadjustment
    label: PT_BILLAdjustment
    type: string
    source: pt
    total: true  
  - name: totaldue
    label: PT_DUE
    type: string
    source: pt
    total: true
  - name: advance
    label: PT_ADVANCE
    type: string
    source: pt
    total: true  
  searchParams:
  - name: fromDate
    label: reports.pt.fromDate
    type: epoch
    source: pt
    isMandatory: false
    searchClause: AND demand.createdtime >= $fromDate
  - name: toDate
    label: reports.pt.toDate
    type: epoch
    source: pt
    isMandatory: false
    searchClause: AND demand.createdtime <= $toDate
  - name: Wardname
    label: Mohalla
    type: singlevaluelist
    pattern: http://egov-location:8080/egov-location/location/v11/boundarys/_search?hierarchyTypeCode=REVENUE&boundaryType=Locality&tenantId=$tenantid|$.TenantBoundary[*].boundary[*].code|$.TenantBoundary[*].boundary[*].name
    source: pt
    wrapper: true
    isMandatory: false
    searchClause: AND locality = $Wardname
  query: | 
    select initcap(split_part(tenantid, '.', 2)) as tenantid,
    consumercode as propertyid, oldpropertyid as oldcode,
    name as name,mobilenumber as mobilenumber,
    (SELECT boundary_def.name FROM (VALUES tbl_boundary) AS boundary_def(name,code) where code=locality) as mohallaname,
    CONCAT(doorno,', ') as address  ,arv,
    initcap(split_part(usagecategory, '.', 1)) as usagetype,initcap(split_part(usagecategory, '.', 2)) as subusagetype,
    CONCAT('House Tax:',SUM(CASE WHEN dem_code = 'PT_HOUSE_TAX' THEN dem_tax ELSE 0 END),E'\n',
    'Water Tax:',  SUM(CASE WHEN dem_code = 'PT_WATER_TAX'  THEN dem_tax ELSE 0 END),E'\n',
    'Conservancy Tax:',SUM(CASE WHEN dem_code = 'PT_CONSERVANCY_TAX' THEN dem_tax ELSE 0 END),E'\n',
    'Education Tax:',SUM(CASE WHEN dem_code = 'PT_EDUCATION_TAX' THEN dem_tax ELSE 0 END),E'\n',
    'Consolidated PT Tax:',SUM(CASE WHEN dem_code = 'PT_CONSOLIDATED_PROPERTY_TAX' THEN dem_tax ELSE 0 END),E'\n',
    'Sanitary Cess:',SUM(CASE WHEN dem_code = 'PT_SANITARY_CESS'  THEN dem_tax ELSE 0 END),E'\n',
    'Education Cess:',SUM(CASE WHEN dem_code = 'PT_EDUCATION_CESS' THEN dem_tax ELSE 0 END),E'\n',
    'Additional Water Tax:',SUM(CASE WHEN dem_code = 'PT_ADDL_WATER_TAX' THEN dem_tax ELSE 0 END),E'\n',
    'Drainage Tax:',SUM(CASE WHEN dem_code = 'PT_DRAINAGE_TAX' THEN dem_tax ELSE 0 END),E'\n',
    'Lighting Tax:',SUM(CASE WHEN dem_code = 'PT_LIGHTING_TAX' THEN dem_tax ELSE 0 END),E'\n',
    'Lighting & Drainage Tax:',SUM(CASE WHEN dem_code = 'PT_LIGHTINING_TAX' THEN dem_tax ELSE 0 END),E'\n',
    'Interest:',SUM(CASE WHEN dem_code = 'PT_TIME_INTEREST' THEN dem_tax ELSE 0 END),E'\n',
    'Demand Notice Charge:',SUM(CASE WHEN dem_code = 'PT_DEMANDNOTICE_CHARGE' THEN dem_tax ELSE 0 END),E'\n',
    'Rebate:',SUM(CASE WHEN dem_code = 'PT_TIME_REBATE' THEN dem_tax ELSE 0 END),E'\n',
    'Total:',SUM(dem_tax)) as Demand,
    CONCAT('House Tax:',SUM(CASE WHEN dem_code = 'PT_HOUSE_TAX' THEN collectionamount ELSE 0 END),E'\n',
    'Water Tax:',  SUM(CASE WHEN dem_code = 'PT_WATER_TAX'  THEN collectionamount ELSE 0 END),E'\n',
    'Conservancy Tax:',SUM(CASE WHEN dem_code = 'PT_CONSERVANCY_TAX' THEN collectionamount ELSE 0 END),E'\n',
    'Education Tax:',SUM(CASE WHEN dem_code = 'PT_EDUCATION_TAX' THEN collectionamount ELSE 0 END),E'\n',
    'Consolidated PT Tax:',SUM(CASE WHEN dem_code = 'PT_CONSOLIDATED_PROPERTY_TAX' THEN collectionamount ELSE 0 END),E'\n',
    'Sanitary Cess:',SUM(CASE WHEN dem_code = 'PT_SANITARY_CESS'  THEN collectionamount ELSE 0 END),E'\n',
    'Education Cess:',SUM(CASE WHEN dem_code = 'PT_EDUCATION_CESS' THEN collectionamount ELSE 0 END),E'\n',
    'Additional Water Tax:',SUM(CASE WHEN dem_code = 'PT_ADDL_WATER_TAX' THEN collectionamount ELSE 0 END),E'\n',
    'Drainage Tax:',SUM(CASE WHEN dem_code = 'PT_DRAINAGE_TAX' THEN collectionamount ELSE 0 END),E'\n',
    'Lighting Tax:',SUM(CASE WHEN dem_code = 'PT_LIGHTING_TAX' THEN collectionamount ELSE 0 END),E'\n',
    'Lighting & Drainage Tax:',SUM(CASE WHEN dem_code = 'PT_LIGHTINING_TAX' THEN collectionamount ELSE 0 END),E'\n',
    'Interest:',SUM(CASE WHEN dem_code = 'PT_TIME_INTEREST' THEN collectionamount ELSE 0 END),E'\n',
    'Demand Notice Charge:',SUM(CASE WHEN dem_code = 'PT_DEMANDNOTICE_CHARGE' THEN collectionamount ELSE 0 END),E'\n',
    'Rebate:',SUM(CASE WHEN dem_code = 'PT_TIME_REBATE' THEN collectionamount ELSE 0 END),E'\n',
    'Total:',SUM(collectionamount)) as totalcollected,
    CONCAT('House Tax:',SUM(CASE WHEN SIGN(amen_tax)=-1 AND amen_code = 'PT_HOUSE_TAX' THEN ABS(amen_tax) ELSE 0 END),E'\n',
    'Water Tax:', SUM(CASE WHEN SIGN(amen_tax)=-1 AND amen_code = 'PT_WATER_TAX'  THEN ABS(amen_tax) ELSE 0 END),E'\n',
    'Conservancy Tax:',SUM(CASE WHEN SIGN(amen_tax)=-1 AND amen_code = 'PT_CONSERVANCY_TAX' THEN ABS(amen_tax) ELSE 0 END),E'\n',
    'Education Tax:',SUM(CASE WHEN SIGN(amen_tax)=-1 AND amen_code = 'PT_EDUCATION_TAX' THEN ABS(amen_tax) ELSE 0 END),E'\n',
    'Consolidated PT Tax:',SUM(CASE WHEN SIGN(amen_tax)=-1 AND amen_code = 'PT_CONSOLIDATED_PROPERTY_TAX' THEN ABS(amen_tax) ELSE 0 END),E'\n',
    'Sanitary Cess:',SUM(CASE WHEN SIGN(amen_tax)=-1 AND amen_code = 'PT_SANITARY_CESS'  THEN ABS(amen_tax) ELSE 0 END),E'\n',
    'Education Cess:',SUM(CASE WHEN SIGN(amen_tax)=-1 AND amen_code = 'PT_EDUCATION_CESS' THEN ABS(amen_tax) ELSE 0 END),E'\n',
    'Additional Water Tax:',SUM(CASE WHEN SIGN(amen_tax)=-1 AND amen_code = 'PT_ADDL_WATER_TAX' THEN ABS(amen_tax) ELSE 0 END),E'\n',
    'Drainage Tax:',SUM(CASE WHEN SIGN(amen_tax)=-1 AND amen_code = 'PT_DRAINAGE_TAX' THEN ABS(amen_tax) ELSE 0 END),E'\n',
    'Lighting Tax:',SUM(CASE WHEN SIGN(amen_tax)=-1 AND amen_code =  'PT_LIGHTING_TAX' THEN  ABS(amen_tax) ELSE 0 END),E'\n',
    'Lighting & Drainage Tax:',SUM(CASE WHEN SIGN(amen_tax)=-1 AND amen_code = 'PT_LIGHTINING_TAX' THEN  ABS(amen_tax) ELSE 0 END),E'\n',
    'Interest:',SUM(CASE WHEN SIGN(amen_tax)=-1 AND amen_code =  'PT_TIME_INTEREST' THEN  ABS(amen_tax) ELSE 0 END),E'\n',
    'Demand Notice Charge:',SUM(CASE WHEN SIGN(amen_tax)=-1 AND amen_code =  'PT_DEMANDNOTICE_CHARGE' THEN  ABS(amen_tax) ELSE 0 END),E'\n',
    'Rebate:',SUM(CASE WHEN SIGN(amen_tax)=-1 AND amen_code = 'PT_TIME_REBATE' THEN  ABS(amen_tax) ELSE 0 END),E'\n',
    'Total:',SUM(amen_tax)  ) as excessadjustment,
    CONCAT('House Tax:',SUM(CASE WHEN SIGN(amen_tax)=1 AND amen_code = 'PT_HOUSE_TAX' THEN ABS(amen_tax) ELSE 0 END),E'\n',
    'Water Tax:',  SUM(CASE WHEN SIGN(amen_tax)=1 AND amen_code = 'PT_WATER_TAX'  THEN ABS(amen_tax) ELSE 0 END),E'\n',
    'Conservancy Tax:',SUM(CASE WHEN SIGN(amen_tax)=1 AND amen_code = 'PT_CONSERVANCY_TAX' THEN ABS(amen_tax) ELSE 0 END),E'\n',
    'Education Tax:',SUM(CASE WHEN SIGN(amen_tax)=1 AND amen_code = 'PT_EDUCATION_TAX' THEN ABS(amen_tax) ELSE 0 END),E'\n',
    'Consolidated PT Tax:',SUM(CASE WHEN SIGN(amen_tax)=1 AND amen_code = 'PT_CONSOLIDATED_PROPERTY_TAX' THEN ABS(amen_tax) ELSE 0 END),E'\n',
    'Sanitary Cess:',SUM(CASE WHEN SIGN(amen_tax)=1 AND amen_code = 'PT_SANITARY_CESS'  THEN ABS(amen_tax) ELSE 0 END),E'\n',
    'Education Cess:',SUM(CASE WHEN SIGN(amen_tax)=1 AND amen_code = 'PT_EDUCATION_CESS' THEN ABS(amen_tax) ELSE 0 END),E'\n',
    'Additional Water Tax:',SUM(CASE WHEN SIGN(amen_tax)=1 AND amen_code = 'PT_ADDL_WATER_TAX' THEN ABS(amen_tax) ELSE 0 END),E'\n',
    'Drainage Tax:',SUM(CASE WHEN SIGN(amen_tax)=1 AND amen_code = 'PT_DRAINAGE_TAX' THEN ABS(amen_tax) ELSE 0 END),E'\n',
    'Lighting Tax:',SUM(CASE WHEN SIGN(amen_tax)=1 AND amen_code =  'PT_LIGHTING_TAX' THEN  ABS(amen_tax) ELSE 0 END),E'\n',
    'Lighting & Drainage Tax:',SUM(CASE WHEN SIGN(amen_tax)=1 AND amen_code = 'PT_LIGHTINING_TAX' THEN  ABS(amen_tax) ELSE 0 END),E'\n',
    'Interest:',SUM(CASE WHEN SIGN(amen_tax)=1 AND amen_code =  'PT_TIME_INTEREST' THEN  ABS(amen_tax) ELSE 0 END),E'\n',
    'Demand Notice Charge:',SUM(CASE WHEN SIGN(amen_tax)=1 AND amen_code =  'PT_DEMANDNOTICE_CHARGE' THEN  ABS(amen_tax) ELSE 0 END),E'\n',
    'Rebate:',SUM(CASE WHEN SIGN(amen_tax)=1 AND amen_code = 'PT_TIME_REBATE' THEN  ABS(amen_tax) ELSE 0 END),E'\n',
    'Total:',SUM(amen_tax)) as billadjustment,
    (SUM(dem_tax)+SUM(collectionamount)+SUM(CASE WHEN (amen_tax)!=0 then amen_tax else 0 end)) as totaldue,
    SUM(CASE WHEN dem_code = 'PT_ADVANCE_CARRYFORWARD' THEN dem_tax ELSE 0 END) as advance
    from (
    select demand.tenantid,
    demand.consumercode,
    addr.doorno,
    addr.locality,
    ptunit.usagecategory,
    ptunit.arv,
    pt.oldpropertyid,
    pt.propertytype,
    CASE WHEN amendtaxdetail.id = demanddetail.id then 0 ELSE demanddetail.taxamount END as dem_tax,
    demanddetail.taxheadcode as dem_code,demanddetail.collectionamount,amendtaxdetail.taxamount as amen_tax,
    amendtaxdetail.taxheadcode as amen_code,poo.name as name,poo.mobilenumber as mobilenumber
    from egbs_demand_v1 demand
    inner join egbs_demanddetail_v1 as demanddetail on demanddetail.demandid= demand.id
    Inner join eg_pt_property as pt on  pt.propertyid=demand.consumercode
    left join egbs_amendment_taxdetail amendtaxdetail on amendtaxdetail.id = demanddetail.id
    Join eg_pt_address as addr on addr.propertyid=pt.id
    Left outer join eg_pt_unit as ptunit on ptunit.propertyid = pt.id
    LEFT JOIN (
      SELECT propertyid, array_to_string(array_agg(name),', ') as name, array_to_string(array_agg(mobilenumber),', ') as mobilenumber
      FROM eg_pt_owner poo
      INNER JOIN eg_user ptuser ON ptuser.uuid = poo.userid group by propertyid)
      poo ON poo.propertyid = pt.id
      where demand.tenantid LIKE $tenantid and demand.businessservice ='PT')t  
  groupby: GROUP BY tenantid,consumercode,doorno,name,oldpropertyid,propertytype,usagecategory,mobilenumber, arv,locality
  orderby: ORDER BY consumercode

- reportName: DGDEDemandRegisterReport
  summary: Reports for Reconcillation of data in PT
  version: 1.0.0
  moduleName: rainmaker-pt
  decryptionPathId: DGDEDemandRegisterReport
  externalService:
  - entity: $.TenantBoundary[0].boundary
    apiURL: http://egov-location:8080/egov-location/location/v11/boundarys/_search?hierarchyTypeCode=REVENUE&boundaryType=Locality&tenantId=$tenantId
    keyOrder: name,code
    tableName: tbl_boundary
  additionalConfig:
    print:
      pdfPageSize: "A2"
  sourceColumns:
  - name: propertyid
    label: reports.pt.propertyId
    type: string
    source: pt
    total: false
  - name: abasid
    label: PT_EXISTING_PROPERTY_ID
    type: string
    source: pt
    total: false
  - name: name
    label: PT_OWNER_NAME
    type: string
    total: false
    source: pt
  - name: mobilenumber
    label: PT_COMMON_APPLICANT_MOBILE_NO_LABEL
    type: string
    total: false
    source: pt    
  - name: doorno
    label: PT_COMMON_DOOR_NO_LABEL
    type: string
    source: pt
    total: false
  - name: mohallaname
    label: PT_PROPERTY_ADDRESS_MOHALLA
    type: string
    source: pt
    total: false
  - name: propertytype
    label: PT_COMMON_PROPERTY_TYPE
    type: string
    source: pt
    total: false
  - name: propertysubtype
    label: reports.pt.Propertysubtype
    type: string
    source: pt
    total: false
  - name: usagetype
    label: PT_COMMON_USAGE_TYPE
    type: string
    source: pt
    total: false
  - name: subusagetype
    label: PT_COMMON_SUB_USAGE_TYPE
    type: string
    source: pt
    total: false
  - name: arv
    label: PT_ASSESMENT_INFO_AREA_RENT
    type: string
    source: pt
    total: true    
  - name: housetax
    label: reports.pt.housetax
    type: string
    source: pt
    total: true
  - name: watertax
    label: PT_WATER_TAX
    type: string
    source: pt
    total: true
  - name: conservancytax
    label: PT_CONSERVANCY_TAX
    type: string
    source: pt
    total: true
  - name: educationtax
    label: PT_EDUCATION_TAX
    type: string
    source: pt
    total: true  
  - name: consolidatedpropertytax
    label: PT_CONSOLIDATED_PROPERTY_TAX
    type: string
    source: pt
    total: true 
  - name: sanitarycess
    label: PT_SANITARY_CESS
    type: string
    source: pt
    total: true
  - name: educationcess
    label: PT_EDUCATION_CESS
    type: string
    source: pt
    total: true 
  - name: additionalwatertax
    label: PT_ADDL_WATER_TAX
    type: string
    source: pt
    total: true 
  - name: drainagetax
    label: PT_DRAINAGE_TAX
    type: string
    source: pt
    total: true 
  - name: demandnoticecharge
    label: reports.pt.demandnotice
    type: string
    source: pt
    total: true  
  - name: interest
    label: reports.pt.interest
    type: string
    source: pt
    total: true  
  - name: totaltax
    label: PT_TOTAL_AMOUNT
    type: string
    source: pt
    total: true
  - name: totalcollected
    label: PT_COLLECTED
    type: string
    source: pt
    total: true
  - name: totaldue
    label: PT_DUE
    type: string
    source: pt
    total: true  
  searchParams:
  - name: fromDate
    label: reports.pt.fromDate
    type: epoch
    source: pt
    isMandatory: false
    searchClause: AND demand.createdtime >= $fromDate
  - name: toDate
    label: reports.pt.toDate
    type: epoch
    source: pt
    isMandatory: false
    searchClause: AND demand.createdtime <= $toDate
  - name: ulb
    label: PT_ULB_CITY
    type: singlevaluelist
    pattern: http://egov-mdms-service:8080/egov-mdms-service/v1/_get?tenantId=$tenantid&moduleName=tenant&masterName=tenants|$.MdmsRes.tenant.tenants.*.code|$.MdmsRes.tenant.tenants.*.name
    source: pt
    wrapper: true
    isMandatory: false
    searchClause: AND pay.tenantid = $ulb
  - name: Wardname
    label: Mohalla
    type: singlevaluelist
    pattern: http://egov-location:8080/egov-location/location/v11/boundarys/_search?hierarchyTypeCode=REVENUE&boundaryType=Locality&tenantId=$tenantid|$.TenantBoundary[*].boundary[*].code|$.TenantBoundary[*].boundary[*].name
    source: pt
    wrapper: true
    isMandatory: false
    searchClause: AND addr.locality = $Wardname
  query: | 
    select initcap(split_part(demand.tenantid, '.', 2)) as tenantid,
    demand.consumercode as propertyid,pt.oldpropertyid as abasid,
    initcap(split_part(pt.propertytype, '.', 1)) as propertytype,
    initcap(split_part(pt.propertytype, '.', 2)) as propertysubtype,
    initcap(split_part(ptunit.usagecategory, '.', 1)) as usagetype,
    initcap(split_part(ptunit.usagecategory, '.', 2)) as subusagetype,
    SUM(CASE WHEN taxheadcode LIKE 'PT_TIME_INTEREST%' THEN demanddetail.taxamount ELSE 0 END) as interest,
    SUM(CASE WHEN taxheadcode LIKE 'PT_DEMANDNOTICE_CHARGE%' THEN demanddetail.taxamount ELSE 0 END) as penalty,
    SUM(CASE WHEN taxheadcode LIKE 'PT_HOUSE_TAX' THEN demanddetail.taxamount ELSE 0 END) as housetax ,
    SUM(CASE WHEN taxheadcode LIKE 'PT_WATER_TAX'  THEN demanddetail.taxamount ELSE 0 END) as watertax ,
    SUM(CASE WHEN taxheadcode LIKE 'PT_CONSERVANCY_TAX' THEN demanddetail.taxamount ELSE 0 END) as conservancytax ,
    SUM(CASE WHEN taxheadcode LIKE 'PT_EDUCATION_TAX' THEN demanddetail.taxamount ELSE 0 END) as educationtax,
    SUM(CASE WHEN taxheadcode LIKE 'PT_CONSOLIDATED_PROPERTY_TAX' THEN demanddetail.taxamount ELSE 0 END) as consolidatedtax ,
    SUM(CASE WHEN taxheadcode LIKE 'PT_SANITARY_CESS'  THEN demanddetail.taxamount ELSE 0 END) as sanitarycess ,
    SUM(CASE WHEN taxheadcode LIKE 'PT_EDUCATION_CESS' THEN demanddetail.taxamount ELSE 0 END) as educationcess ,
    SUM(CASE WHEN taxheadcode LIKE 'PT_ADDL_WATER_TAX' THEN demanddetail.taxamount ELSE 0 END) as additionalwatertax ,
    SUM(CASE WHEN taxheadcode LIKE 'PT_DRAINAGE_TAX' THEN demanddetail.taxamount ELSE 0 END) as drainagetax,
    (SUM(CASE WHEN taxheadcode LIKE 'PT_TIME_INTEREST' THEN demanddetail.taxamount ELSE 0 END)  + SUM(CASE WHEN taxheadcode LIKE 'PT_DEMANDNOTICE_CHARGE%' THEN demanddetail.taxamount ELSE 0 END) +SUM(CASE WHEN taxheadcode LIKE 'PT_HOUSE_TAX' THEN demanddetail.taxamount ELSE 0 END) +SUM(CASE WHEN taxheadcode LIKE 'PT_WATER_TAX' THEN demanddetail.taxamount ELSE 0 END)  +SUM(CASE WHEN taxheadcode LIKE 'PT_CONSERVANCY_TAX' THEN demanddetail.taxamount ELSE 0 END)+SUM(CASE WHEN taxheadcode LIKE 'PT_EDUCATION_TAX' THEN demanddetail.taxamount ELSE 0 END)+SUM(CASE WHEN taxheadcode LIKE 'PT_ADDL_WATER_TAX' THEN demanddetail.taxamount ELSE 0 END)+SUM(CASE WHEN taxheadcode LIKE 'PT_DRAINAGE_TAX' THEN demanddetail.taxamount ELSE 0 END)  +SUM(CASE WHEN taxheadcode LIKE 'PT_EDUCATION_CESS' THEN demanddetail.taxamount ELSE 0 END) +SUM(CASE WHEN taxheadcode LIKE 'PT_SANITARY_CESS' THEN demanddetail.taxamount ELSE 0 END) +SUM(CASE WHEN taxheadcode LIKE 'PT_CONSOLIDATED_PROPERTY_TAX' THEN demanddetail.taxamount ELSE 0 END)) as totaltax,
    (SUM(CASE WHEN taxheadcode LIKE 'PT_TIME_INTEREST' THEN demanddetail.collectionamount ELSE 0 END)  + SUM(CASE WHEN taxheadcode LIKE 'PT_DEMANDNOTICE_CHARGE%' THEN demanddetail.collectionamount ELSE 0 END)+SUM(CASE WHEN taxheadcode LIKE 'PT_HOUSE_TAX' THEN demanddetail.collectionamount ELSE 0 END) +SUM(CASE WHEN taxheadcode LIKE 'PT_WATER_TAX' THEN demanddetail.collectionamount ELSE 0 END)  +SUM(CASE WHEN taxheadcode LIKE 'PT_CONSERVANCY_TAX' THEN demanddetail.collectionamount ELSE 0 END) +SUM(CASE WHEN taxheadcode LIKE 'PT_EDUCATION_TAX' THEN demanddetail.collectionamount ELSE 0 END)+SUM(CASE WHEN taxheadcode LIKE 'PT_ADDL_WATER_TAX' THEN demanddetail.collectionamount ELSE 0 END)+SUM(CASE WHEN taxheadcode LIKE 'PT_CONSOLIDATED_PROPERTY_TAX' THEN demanddetail.collectionamount ELSE 0 END) +SUM(CASE WHEN taxheadcode LIKE 'PT_SANITARY_CESS' THEN demanddetail.collectionamount ELSE 0 END)  +SUM(CASE WHEN taxheadcode LIKE 'PT_EDUCATION_CESS' THEN demanddetail.collectionamount ELSE 0 END) +SUM(CASE WHEN taxheadcode LIKE 'PT_DRAINAGE_TAX' THEN demanddetail.collectionamount ELSE 0 END))as totalcollection,
    ((SUM(CASE WHEN taxheadcode LIKE 'PT_TIME_INTEREST' THEN demanddetail.taxamount ELSE 0 END)  + SUM(CASE WHEN taxheadcode LIKE 'PT_DEMANDNOTICE_CHARGE%' THEN demanddetail.taxamount ELSE 0 END) +SUM(CASE WHEN taxheadcode LIKE 'PT_HOUSE_TAX' THEN demanddetail.taxamount ELSE 0 END) +SUM(CASE WHEN taxheadcode LIKE 'PT_WATER_TAX' THEN demanddetail.taxamount ELSE 0 END)  +SUM(CASE WHEN taxheadcode LIKE 'PT_CONSERVANCY_TAX' THEN demanddetail.taxamount ELSE 0 END)+SUM(CASE WHEN taxheadcode LIKE 'PT_EDUCATION_TAX' THEN demanddetail.taxamount ELSE 0 END)+SUM(CASE WHEN taxheadcode LIKE 'PT_ADDL_WATER_TAX' THEN demanddetail.taxamount ELSE 0 END)+SUM(CASE WHEN taxheadcode LIKE 'PT_DRAINAGE_TAX' THEN demanddetail.taxamount ELSE 0 END)  +SUM(CASE WHEN taxheadcode LIKE 'PT_EDUCATION_CESS' THEN demanddetail.taxamount ELSE 0 END) +SUM(CASE WHEN taxheadcode LIKE 'PT_SANITARY_CESS' THEN demanddetail.taxamount ELSE 0 END) +SUM(CASE WHEN taxheadcode LIKE 'PT_CONSOLIDATED_PROPERTY_TAX' THEN demanddetail.taxamount ELSE 0 END))- (SUM(CASE WHEN taxheadcode LIKE 'PT_TIME_INTEREST' THEN demanddetail.collectionamount ELSE 0 END)  + SUM(CASE WHEN taxheadcode LIKE 'PT_DEMANDNOTICE_CHARGE%' THEN demanddetail.collectionamount ELSE 0 END)+SUM(CASE WHEN taxheadcode LIKE 'PT_HOUSE_TAX' THEN demanddetail.collectionamount ELSE 0 END) +SUM(CASE WHEN taxheadcode LIKE 'PT_WATER_TAX' THEN demanddetail.collectionamount ELSE 0 END)  +SUM(CASE WHEN taxheadcode LIKE 'PT_CONSERVANCY_TAX' THEN demanddetail.collectionamount ELSE 0 END) +SUM(CASE WHEN taxheadcode LIKE 'PT_EDUCATION_TAX' THEN demanddetail.collectionamount ELSE 0 END)+SUM(CASE WHEN taxheadcode LIKE 'PT_CONSOLIDATED_PROPERTY_TAX' THEN demanddetail.collectionamount ELSE 0 END) +SUM(CASE WHEN taxheadcode LIKE 'PT_SANITARY_CESS' THEN demanddetail.collectionamount ELSE 0 END)  +SUM(CASE WHEN taxheadcode LIKE 'PT_EDUCATION_CESS' THEN demanddetail.collectionamount ELSE 0 END) +SUM(CASE WHEN taxheadcode LIKE 'PT_ADDL_WATER_TAX' THEN demanddetail.collectionamount ELSE 0 END)+SUM(CASE WHEN taxheadcode LIKE 'PT_DRAINAGE_TAX' THEN demanddetail.collectionamount ELSE 0 END)) ) as totaldue,
    ptunit.arv as arv,addr.doorno as doorno,(SELECT boundary_def.name FROM (VALUES tbl_boundary) AS boundary_def(name,code) where code=addr.locality) as mohallaname,
    poo.name as name,
    poo.mobilenumber as mobilenumber
    from egbs_demand_v1 demand
    inner join egbs_demanddetail_v1 as demanddetail on demanddetail.demandid= demand.id
    Inner join eg_pt_property as pt on  pt.propertyid=demand.consumercode
    Join eg_pt_address as addr on addr.propertyid=pt.id
    Left outer join eg_pt_unit as ptunit on ptunit.propertyid = pt.id
    LEFT JOIN (
      SELECT propertyid, array_to_string(array_agg(name),', ') as name, array_to_string(array_agg(mobilenumber),', ') as mobilenumber
      FROM eg_pt_owner poo
      poo ON poo.propertyid = pt.id
      where demand.tenantid != 'pb.testing' and demand.businessservice ='PT' 
  groupby: GROUP BY demand.tenantid,demand.consumercode,addr.doorno,addr.doorno,poo.name,pt.oldpropertyid,pt.propertytype,ptunit.usagecategory,poo.mobilenumber, ptunit.arv,addr.locality
  orderby: ORDER BY demand.consumercode
